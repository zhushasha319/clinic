# 医院项目代码地图（路由 / 模块 / 数据流）

## 1) 关键路由

| 分组 | 路由 | 主要入口文件 | 关键 action |
|---|---|---|---|
| 认证 | `/sign-in` / `/sign-up` / `/sign-out` | `app/(auth)/*` | `signInWithCredentials`、`signUp`、`signOutUser` |
| 用户首页 | `/` | `app/(root)/page.tsx` | `getOurDoctors`（医生卡数据） |
| 医生详情+排班 | `/doctors/[doctorId]` | `app/(root)/doctors/[doctorId]/page.tsx` | `getDoctorDetails`、`getDoctorReviewStats`、`getAvailableDoctorSlots` |
| 患者信息确认 | `/appointments/patient-details` | `app/(root)/appointments/patient-details/page.tsx` | `getAppointmentData`、`updateGuestAppointmentWithUser`、`processAppointmentBooking` |
| 支付页 | `/appointments/payment` | `app/(root)/appointments/payment/page.tsx` | `confirmCashAppointment`、`createAlipayPayment` |
| 支付成功页 | `/appointments/payment/success` | `app/(root)/appointments/payment/success/page.tsx` | （读库展示，测试模式会更新预约状态） |
| 个人中心 | `/user/profile` | `app/(root)/user/profile/page.tsx` | `getUserDetails`、`getUserAppointments`、`cancelCashAppointment`、`submitPatientReview` |
| 管理后台总览 | `/admin/dashboard` | `app/(admin)/admin/dashboard/page.tsx` | `getAdminDashboardData` |
| 管理后台-医生 | `/admin/doctors` | `app/(admin)/admin/doctors/page.tsx` | `getDoctorList`、`createDoctor`、`updateDoctor`、`deleteDoctor` |
| 管理后台-请假 | `/admin/doctors/[doctorId]/manage` | `app/(admin)/admin/doctors/[doctorId]/manage/page.tsx` | `getDoctorLeaveMonth`、`setDoctorLeave`、`removeDoctorLeave` |
| 管理后台-预约处理 | `/admin/appointment-action` | `app/(admin)/admin/appointment-action/page.tsx` | `searchAppointmentsByPatientName`、`markCashAsPaid`、`markAppointmentCancelled`、`markAppointmentNoShow`、`markAppointmentCompleted` |
| API | `/api/auth/[...nextauth]`、`/api/payment/create`、`/api/webhooks/pingxx`、`/api/uploadthing` | `app/api/*` | 鉴权、支付下单、支付回调、文件上传 |

---

## 2) 模块分层

- 路由层：`app/**/page.tsx`（参数解析、鉴权、组合数据、渲染页面）
- 交互层：`components/**` + `hooks/**`（表单、日历、分页、按钮行为）
- 业务层：`lib/actions/**`（核心业务规则：预约、支付、评价、后台管理）
- 数据层：`db/prisma.ts` + `prisma/schema.prisma`（Prisma Client + PostgreSQL）
- 全局守卫：`middleware.ts` + `lib/auth-guard.ts`（保护 `/admin` `/user` `/appointments`，并做管理员校验）

---

## 3) 核心数据流（主链路）

### A. 用户预约到支付
1. 医生详情页选择日期/时段  
   `getAvailableDoctorSlots` 读取 `app_settings + doctor_leaves + appointments`
2. 点击继续预留时段  
   登录用户走 `createOrUpdateAppointmentReservation`，访客走 `createGuestAppointment`
3. 进入患者信息页  
   `getAppointmentData` 校验预约存在、状态、过期时间；未登录访客可凭 HttpOnly Cookie 中的 `guestIdentifier` 继续填写，登录后可用 `updateGuestAppointmentWithUser` 绑定账号（URL 仅带 `appointmentId`，支付前强制登录）；若为 `MYSELF` 在进入支付页时会按账号资料同步患者信息
4. 提交就诊信息  
   `processAppointmentBooking` 更新 `appointments`（患者信息、联系方式、就诊原因）
5. 支付  
   现金：`confirmCashAppointment`（状态变更为 `CASH`）  
   支付宝：`createAlipayPayment` -> Ping++ -> `/api/webhooks/pingxx` -> `handleAlipayWebhook`
6. 成功页展示  
   `/appointments/payment/success` 读取预约详情回显

### B. 管理后台运营
1. 仪表盘：`getAdminDashboardData` 聚合 `transactions + appointments`
2. 医生管理：`create/update/deleteDoctor` 维护 `users + doctor_profiles`
3. 请假管理：`setDoctorLeave/removeDoctorLeave` 维护 `doctor_leaves`，并校验是否已有预约冲突
4. 预约处理：`markCashAsPaid/cancel/no_show/completed` 更新 `appointments`，必要时同步 `transactions`

---

## 4) 关键 Prisma 表
- `users`：所有账号（患者/医生/管理员）主表
- `doctor_profiles`：医生扩展资料（科室、简介、评分、擅长方向）
- `appointments`：预约核心事实表（时段、患者信息、状态、支付字段）
- `doctor_leaves`：医生请假/不可用日期
- `doctor_testimonials`：患者评价（与预约一对一）
- `transactions`：资金流水（后台营收与交易明细来源）
- `app_settings`：排班策略（开诊时间、每小时号源、预留过期分钟数）

---

## 5) 关键状态机

- 预约状态：`PAYMENT_PENDING -> BOOKING_CONFIRMED -> COMPLETED`
- 现金分支：`PAYMENT_PENDING -> CASH -> (BOOKING_CONFIRMED / CANCELLED / NO_SHOW)`
- 在线支付失败回滚：`BOOKING流程中失败 -> PAYMENT_PENDING`

