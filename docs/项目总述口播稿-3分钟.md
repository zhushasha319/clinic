# 项目总述口播稿（约 3 分钟）

大家好，我用 3 分钟介绍一下这个医院预约项目的代码结构和核心流程。

先说一句总览：这个项目是 Next.js App Router 架构，前端页面在 `app` 和 `components`，核心业务规则都在 `lib/actions`，数据层是 Prisma + PostgreSQL，权限由 `middleware.ts` 和 `requireAdmin` 双层控制。

第一部分，用户主链路。  
用户先在 `/doctors/[doctorId]` 看医生详情并选时段。这里最关键的 action 是 `getAvailableDoctorSlots`，它会同时看三类数据：`app_settings` 生成基础号源、`doctor_leaves` 扣掉请假时间、`appointments` 扣掉已占用时段。  
用户点继续后，会创建预约预留：登录用户走 `createOrUpdateAppointmentReservation`，访客走 `createGuestAppointment`。这一步写入 `appointments`，状态是 `PAYMENT_PENDING`，并带一个过期时间。  
然后进入 `/appointments/patient-details`。如果是访客先选号后登录，会走 `updateGuestAppointmentWithUser` 把预约绑定到账号；提交表单时走 `processAppointmentBooking`，把就诊人、电话、就诊原因等写回 `appointments`。  
最后进 `/appointments/payment`：现金走 `confirmCashAppointment`，支付宝走 `createAlipayPayment`，再通过 `/api/webhooks/pingxx` 调 `handleAlipayWebhook` 回写支付结果。成功后到 `/appointments/payment/success` 展示最终预约信息。

第二部分，后台主链路。  
`/admin/dashboard` 用 `getAdminDashboardData` 聚合 `transactions` 和 `appointments`，输出营收趋势、科室占比、最近交易。  
`/admin/doctors` 用 `createDoctor/updateDoctor/deleteDoctor` 维护医生账号和资料，核心是 `users + doctor_profiles`。  
`/admin/doctors/[doctorId]/manage` 管理请假，`setDoctorLeave/removeDoctorLeave` 写 `doctor_leaves`，并校验当天有没有预约冲突。  
`/admin/appointment-action` 处理预约状态，常见动作是标记现金已付、取消、未到诊、完成，会更新 `appointments`，必要时同步 `transactions`。

第三部分，必须记住的三个关键词：  
关键路由：医生详情页、患者信息页、支付页、后台三个管理页。  
关键 action：`getAvailableDoctorSlots`、`processAppointmentBooking`、`createAlipayPayment`、`getAdminDashboardData`。  
关键表：`appointments`、`users`、`doctor_profiles`、`transactions`、`doctor_leaves`。

最后一句总结：这个系统的核心就是“先锁号，再补全信息，再支付确认，再后台运营闭环”，所有业务都围绕 `appointments` 这张主表流转。

---