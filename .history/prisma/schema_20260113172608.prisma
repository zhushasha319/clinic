// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures=['driverAdapters']
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
}

enum LeaveType {
  FULL_DAY
  MORNING
  AFTERNOON
}

enum PatientType {
  MYSELF
  SOMEONE_ELSE
}

enum AppointmentStatus {
  PAYMENT_PENDING
  BOOKING_CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
  CASH
}

enum TransactionStatus {
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String    @default("NO_NAME")
  email         String    @unique
  password      String?
  emailVerified DateTime?
  role          UserRole  @default(PATIENT)
  isRootAdmin   Boolean?  @default(false)
  image         String?
  dateofbirth   DateTime?
  phoneNumber   String?
  address       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts           Account[]
  doctorProfile      DoctorProfile?
  doctorLeaves       DoctorLeave[]
  appointmentsAsDoctor Appointment[]      @relation("DoctorAppointments")
  appointmentsAsPatient Appointment[]     @relation("PatientAppointments")
  testimonialsGiven  DoctorTestimonial[] @relation("PatientTestimonials")
  testimonialsReceived DoctorTestimonial[] @relation("DoctorTestimonials")
  transactions       Transaction[]

  @@map("users")
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// DOCTOR PROFILE & AVAILABILITY
// ============================================================================

model DoctorProfile {
  profileId      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String   @unique
  specialty        String
  brief            String
  credentials      String
  languages        String[]
  rating           Float    @default(0)
  reviewCount      Int      @default(0)
  specializations  String[]
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("doctor_profiles")
}

model DoctorLeave {
  leaveId   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  doctorId  String
  leaveDate DateTime  @db.Date
  leaveType LeaveType
  reason    String?
  createdAt DateTime  @default(now())

  doctor User @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, leaveDate])
  @@map("doctor_leaves")
}

// ============================================================================
// APPLICATION SETTINGS
// ============================================================================

model AppSettings {
  id                      String @id @default("global")
  slotsPerHour            Int    @default(2)
  startTime               String @default("09:00")
  endTime                 String @default("17:00")
  slotReservationDuration Int    @default(10)

  @@map("app_settings")
}

model WorkingDay {
  dayId        String  @id @default(uuid())
  dayOfWeek    Int
  isWorkingDay Boolean @default(true)

  @@map("working_days")
}

// ============================================================================
// APPOINTMENTS & BOOKINGS
// ============================================================================

model Appointment {
  appointmentId       String            @id @default(uuid())
  doctorId            String
  userId              String?
  guestIdentifier     String?
  patientType         PatientType
  patientRelation     String?
  patientName         String
  paymentMethod       String?
  paymentResult       Json?
  paidAt              DateTime?
  appointmentStartUTC DateTime
  appointmentEndUTC   DateTime
  phoneNumber         String?
  reasonForVisit      String?
  additionalNotes     String?
  patientdateofbirth  DateTime?
  reservationExpiresAt DateTime?
  status              AppointmentStatus @default(PAYMENT_PENDING)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  doctor       User                @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade)
  patient      User?               @relation("PatientAppointments", fields: [userId], references: [id], onDelete: SetNull)
  testimonials DoctorTestimonial[]
  transactions Transaction[]

  @@map("appointments")
}

// ============================================================================
// REVIEWS & TESTIMONIALS
// ============================================================================

model DoctorTestimonial {
  testimonialId   String    @id @default(uuid())
  appointmentId   String    @unique
  doctorId        String
  patientId       String?
  testimonialText String
  rating          Float?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [appointmentId], onDelete: Cascade)
  doctor      User        @relation("DoctorTestimonials", fields: [doctorId], references: [id], onDelete: Cascade)
  patient     User?       @relation("PatientTestimonials", fields: [patientId], references: [id], onDelete: SetNull)

  @@map("doctor_testimonials")
}

// ============================================================================
// PAYMENTS & TRANSACTIONS
// ============================================================================

model Transaction {
  id                   String            @id @default(uuid())
  appointmentId        String
  doctorId             String
  paymentGateway       String
  gatewayTransactionId String
  amount               Float
  currency             String
  status               TransactionStatus
  transactionDate      DateTime
  notes                String?
  paymentDetails       Json?

  appointment Appointment @relation(fields: [appointmentId], references: [appointmentId], onDelete: Cascade)
  doctor      User        @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

// ============================================================================
// CMS & CONTENT MANAGEMENT
// ============================================================================

model BannerImage {
  id        String   @id @default(uuid())
  name      String   @unique
  imageUrl  String
  fileKey   String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("banner_images")
}

model Department {
  id        String   @id @default(uuid())
  name      String   @unique
  iconName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("departments")
}
